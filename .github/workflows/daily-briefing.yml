# 일일 마켓 브리핑 자동 생성 워크플로우
#
# 모닝 브리핑 (08:00 KST): 장 시작 전 투자 준비
# 미드데이 브리핑 (12:30 KST): 장중 시장 점검
# 애프터 마켓 브리핑 (18:00 KST): 장 마감 후 시장 요약
#
# 사용법:
#   1. GitHub 저장소 Settings > Secrets and variables > Actions에서 시크릿 추가
#      - DART_API_KEY (선택)
#      - ECOS_API_KEY (선택)
#   2. Settings > Variables > Repository variables에서 변수 추가
#      - BRIEFING_ENABLED: "true" (활성화) 또는 "false" (비활성화)

name: Daily Market Briefing

on:
  # 스케줄 실행 (UTC 기준, 한국시간 -9시간)
  schedule:
    - cron: '0 23 * * 0-4'  # UTC 23:00 = KST 08:00 (모닝, 일~목 → 월~금)
    - cron: '30 3 * * 1-5'  # UTC 03:30 = KST 12:30 (미드데이, 월~금)
    - cron: '0 9 * * 1-5'   # UTC 09:00 = KST 18:00 (애프터마켓, 월~금)

  # 수동 실행 허용
  workflow_dispatch:
    inputs:
      force_run:
        description: 'BRIEFING_ENABLED 설정 무시하고 강제 실행'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      briefing_type:
        description: '브리핑 유형 선택'
        required: false
        default: 'aftermarket'
        type: choice
        options:
          - 'morning'
          - 'midday'
          - 'aftermarket'

jobs:
  check-enabled:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      briefing_type: ${{ steps.determine-type.outputs.briefing_type }}
    steps:
      - name: Check if enabled
        id: check
        run: |
          if [ "${{ github.event.inputs.force_run }}" == "true" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "강제 실행 모드"
            exit 0
          fi

          ENABLED="${{ vars.BRIEFING_ENABLED }}"
          if [ "$ENABLED" == "true" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "자동 실행 활성화됨"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "자동 실행 비활성화됨 (BRIEFING_ENABLED=$ENABLED)"
          fi

      - name: Determine briefing type
        id: determine-type
        run: |
          # 수동 실행: 선택한 유형 사용
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "briefing_type=${{ github.event.inputs.briefing_type }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          # 스케줄: KST 시간으로 자동 판단
          KST_HOUR=$(TZ='Asia/Seoul' date +'%H')
          if [ "$KST_HOUR" -lt "10" ]; then
            echo "briefing_type=morning" >> $GITHUB_OUTPUT
            echo "모닝 브리핑 (KST $KST_HOUR시)"
          elif [ "$KST_HOUR" -lt "15" ]; then
            echo "briefing_type=midday" >> $GITHUB_OUTPUT
            echo "미드데이 브리핑 (KST $KST_HOUR시)"
          else
            echo "briefing_type=aftermarket" >> $GITHUB_OUTPUT
            echo "애프터 마켓 브리핑 (KST $KST_HOUR시)"
          fi

  generate-briefing:
    needs: check-enabled
    if: needs.check-enabled.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file
        run: |
          echo "DART_API_KEY=${{ secrets.DART_API_KEY }}" >> .env
          echo "ECOS_API_KEY=${{ secrets.ECOS_API_KEY }}" >> .env
          echo "WATCHLIST_STOCKS=005930,000660,016360,316140,003230" >> .env

      - name: Generate market briefing
        run: |
          python scripts/main.py --type ${{ needs.check-enabled.outputs.briefing_type }}

      - name: Get current date (KST)
        id: date
        run: |
          echo "date=$(TZ='Asia/Seoul' date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Commit and push briefing
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add notes/daily_briefing/
          BTYPE="${{ needs.check-enabled.outputs.briefing_type }}"
          if [ "$BTYPE" == "morning" ]; then
            MSG="docs: 모닝 브리핑 자동 생성 (${{ steps.date.outputs.date }})"
          elif [ "$BTYPE" == "midday" ]; then
            MSG="docs: 미드데이 브리핑 자동 생성 (${{ steps.date.outputs.date }})"
          else
            MSG="docs: 애프터 마켓 브리핑 자동 생성 (${{ steps.date.outputs.date }})"
          fi
          git diff --staged --quiet || git commit -m "$MSG"
          git push

      - name: Summary
        run: |
          BTYPE="${{ needs.check-enabled.outputs.briefing_type }}"
          echo "## 마켓 브리핑 생성 완료 ($BTYPE)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- 날짜: ${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "- 유형: $BTYPE" >> $GITHUB_STEP_SUMMARY

  skipped:
    needs: check-enabled
    if: needs.check-enabled.outputs.should_run == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Skipped notice
        run: |
          echo "## 마켓 브리핑 건너뜀" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "BRIEFING_ENABLED가 'true'로 설정되지 않았습니다." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "활성화하려면:" >> $GITHUB_STEP_SUMMARY
          echo "1. Settings > Secrets and variables > Actions > Variables 이동" >> $GITHUB_STEP_SUMMARY
          echo "2. BRIEFING_ENABLED 변수를 'true'로 설정" >> $GITHUB_STEP_SUMMARY
